// Dependency Update Configuration
//
// See https://docs.renovatebot.com/configuration-options/
// See https://json5.org/ for JSON5 syntax

// [!] While updating the Renovate config, test changes on your own fork.
//  1. Modify the Renovate configuration, which is located in .github/renovate.json5 and push your changes to the default branch of your fork.
//  2. Enable the Renovate GitHub app in your GitHub account.
//     Verify that Renovate is activated in the repository settings within the Renovate Dashboard.
//     To enable the dashboard set `dependencyDashboard` to true
//  3. Trigger the Renovate app from the dashboard, or push a new commit to your fork’s default branch to re-trigger Renovate.
//  4. Use the dashboard to initiate Renovate and create a PR on your fork, then check that the proposed PRs are modifying the correct parts.
//  5. Once you’ve validated that the Renovate configuration works on your fork, submit a PR,
//     and include links in the description to share details about the testing you've conducted.

{
  $schema: "https://docs.renovatebot.com/renovate-schema.json",

  // regenerate lock weekly https://docs.renovatebot.com/configuration-options/#lockfilemaintenance
  lockFileMaintenance: {
    enabled: true,
    schedule: ["* * * * 0"], // weekly
  },

  extends: ["config:base", ":gitSignOff", "helpers:pinGitHubActionDigests"],
  // https://docs.renovatebot.com/presets-default/#gitsignoff
  // https://docs.renovatebot.com/presets-helpers/#helperspingithubactiondigests

  // if necessary, add supported releases branches here
  // it is possible to enable/disable specific upgrades per branch with
  // `matchBaseBranches` in specific rule
  baseBranches: ["main"],

  enabledManagers: ["dockerfile", "github-actions", "gomod", "pep621", "npm"],

  // ignore Geti components
  ignoreDeps: [
    "geti.com/iai_core",
    "geti.com/modelmesh",
    "geti.com/modelregistration",
    "geti.com/predict",
    "geti.com/account_service_grpc",
    "geti.com/credit_system",
  ],

  // Set limit to 5
  ignorePresets: [":prHourlyLimit2"],
  prHourlyLimit: 5,
  ignorePaths: ["interactive_ai/tests/e2e/**"], // to exclude specific test folder

  // https://docs.renovatebot.com/golang/
  postUpdateOptions: ["gomodTidy"],

  packageRules: [
    // Enable pinning for container images
    // https://docs.renovatebot.com/presets-docker/#dockerpindigests
    {
      enabled: true,
      matchDatasources: ["docker"],
      pinDigests: true,
      groupName: "Pin dependencies",
      groupSlug: "pin-deps",
      schedule: ["* * * * 0"], // weekly
    },

    // Disable non-security upgrades for go and npm.
    // We will enable it in the next phase
    {
      enabled: false,
      matchManagers: ["gomod", "npm"],
    },

    // Disable non-security upgrades for pypi, except lock file update
    {
      enabled: false,
      matchDatasources: ["pypi"],
    },

    // Python version in TOML is updated manually
    {
      enabled: false,
      matchDatasources: ["python-version"],
      matchDepTypes: ["requires-python"],
      matchDepNames: ["python"],
    },

    // Disable upgrades for Dockerfile syntax (docker/dockerfile)
    {
      enabled: false,
      matchDatasources: ["docker"],
      matchDepNames: ["docker/dockerfile"],
    },

    // Disable python base image upgrades, except digital pinning,
    // we will enable it in the next phase
    {
      enabled: false,
      matchDatasources: ["docker"],
      matchPackageNames: ["python"],
      matchUpdateTypes: ["major", "minor", "patch"],
    },

    {
      enabled: false,
      matchDatasources: ["docker"],
      matchPackageNames: ["docker.io/python"],
      matchUpdateTypes: ["major", "minor", "patch"],
    },

    // Disable golang base image upgrades, except digital pinning,
    // we will enable it in the next phase
    {
      enabled: false,
      matchDatasources: ["docker"],
      matchPackageNames: ["golang"],
      matchUpdateTypes: ["major", "minor", "patch"],
    },

    // Disable nginx base image upgrades, except digital pinning,
    // we will enable it in the next phase
    {
      enabled: false,
      matchDatasources: ["docker"],
      matchPackageNames: ["nginx"],
      matchUpdateTypes: ["major", "minor", "patch"],
    },

    // Disable node image upgrades, except digital pinning,
    // we will enable it in the next phase
    {
      enabled: false,
      matchDatasources: ["docker"],
      matchPackageNames: ["node"],
      matchUpdateTypes: ["major", "minor", "patch"],
    },

    // Disable ghcr.io/astral-sh/uv image upgrades, except digital pinning,
    // we will enable it in the next phase
    {
      enabled: false,
      matchDatasources: ["docker"],
      matchPackageNames: ["ghcr.io/astral-sh/uv"],
      matchUpdateTypes: ["major", "minor", "patch"],
    },

    // Group GitHub Actions updates
    {
      enabled: true,
      separateMajorMinor: false,
      groupName: "GitHub Actions",
      matchManagers: ["github-actions"],
      matchPackagePatterns: ["*"],
      schedule: ["* * 1,15 * *"], // twice a month
    },

    // Go version used in GitHub Actions is updated manually
    {
      enabled: false,
      matchDatasources: ["github-releases"],
      matchDepNames: ["go"],
      matchDepTypes: ["uses-with"],
    },

    // Node version used in GitHub Actions is updated manually
    {
      enabled: false,
      matchDatasources: ["github-releases"],
      matchDepNames: ["node"],
      matchDepTypes: ["uses-with"],
    },

    // Disable mcr.microsoft.com/playwright image upgrades, except digital pinning,
    {
      enabled: false,
      matchManagers: ["github-actions"],
      matchDepTypes: ["container"],
      matchDepNames: ["mcr.microsoft.com/playwright"],
      matchUpdateTypes: ["major", "minor", "patch"],
    },

    // Group Go version upgrades
    {
      enabled: true,
      matchPackageNames: ["golang", "go"],
      allowedVersions: "<1.24",
      groupName: "Go version",
      groupSlug: "go-version",
      schedule: ["* * * * 0"], // weekly
    },

    // Disable upgrades for non production images
    {
      enabled: false,
      matchDatasources: ["docker"],
      matchFileNames: ["**/Dockerfile.protoc"],
    },
  ],

  // Enable security upgrades
  vulnerabilityAlerts: {
    enabled: true,
  },
  osvVulnerabilityAlerts: true,
  dependencyDashboard: true,
}
