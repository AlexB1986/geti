# Copyright (C) 2022-2025 Intel Corporation
# LIMITED EDGE SOFTWARE DISTRIBUTION LICENSE

package istio.authz

import future.keywords
import future.keywords.every
import input.attributes.request.http as http_request
import input.parsed_path
import input.parsed_query

test_health_allowed {
    allow with input as {
        "attributes": {"request": {"http": {
            "method": "GET",
            "path": "/health/",
        }}},
        "parsed_path": [
            "health",
            "",
        ],
    }
}

test_onboarding_user_allowed {
    allow with input as {
        "attributes": {"request": {"http": {
            "headers": {"x-auth-request-access-token": "eyJhbGciOiJSUzUxMiIsImtpZCI6IjYxOWI0OTg2MzM5ZTgyMmFlOTM3YjNkNWFlZTJjZWY2MmE1MDA5YjM2MzQzYmE5MzY0MTVhM2MyMTNhY2FiOTRlZmExNmFhZDdhNzI0ZjNkNTk1ZmRiNjlkNDY5MTU1MDcxNWVhYWM4ZmUzMWQ3Yjg5NDJjMGE0YjY3YTZkODBlIiwidHlwIjoiSldUIn0.eyJyb2xlcyI6bnVsbCwidGlkIjoiIiwicHJlZmVycmVkX3VzZXJuYW1lIjoiNTFlNjNiYjktNDMyNC00ODdhLWE2ODAtZTQzOTU0MGFjODJlIiwib3JnYW5pemF0aW9uX2lkIjoiYTM1MGI0NTQtY2M4MC00ZDQxLWI3MmQtMzA2MzNkNjNmMjRkIiwiZXh0ZXJuYWxfdG9rZW4iOiJleUpoYkdjaU9pSlNVekkxTmlJc0ltdHBaQ0k2SW1OaU1XVmlNakJrTWpreU9URmhPVGd6WXpabFkyRTRaak14WXpRNVlUZGxZelF6TmpFME16VWlmUS5leUpwYzNNaU9pSm9kSFJ3Y3pvdkx6RXdMalUxTGpJMU1pNHhOVEF2WkdWNElpd2ljM1ZpSWpvaVEycHNhbUpxTURGTlYxVXlUVEpLYVU5VE1EQk5la2t3VEZSUk5FNHlSWFJaVkZrMFRVTXhiRTVFVFRWT1ZGRjNXVmROTkUxdFZYTmFSMDA1V2xob2FHSllRbk5hVTNocldYb3hkbU50WTFORVdFcHNXak5XYzFsWVNtWmtXRTVzWTI1Tklpd2lZWFZrSWpvaWQyVmlYM1ZwSWl3aVpYaHdJam94TnpBM01qazRORFE1TENKcFlYUWlPakUzTURjeU9UUXlORGtzSW1GMFgyaGhjMmdpT2lKclpWTmZUM3B6Tms0eGNpMXNhbko2V2s5WWFHVkJJaXdpWTE5b1lYTm9Jam9pU1haVVl6SjVVREF5WlUxdlRIWmxOWFpqUTNwamR5SXNJbVZ0WVdsc0lqb2lZV1J0YVc1QWMyTXRjSEp2YW1WamRDNXBiblJsYkM1amIyMGlMQ0psYldGcGJGOTJaWEpwWm1sbFpDSTZkSEoxWlN3aWJtRnRaU0k2SWpVeFpUWXpZbUk1TFRRek1qUXRORGczWVMxaE5qZ3dMV1UwTXprMU5EQmhZemd5WlNJc0luQnlaV1psY25KbFpGOTFjMlZ5Ym1GdFpTSTZJalV4WlRZelltSTVMVFF6TWpRdE5EZzNZUzFoTmpnd0xXVTBNemsxTkRCaFl6Z3laU0o5Lm5ydkF1THRmZ19hVzdtcWZFeW5Zb2FMc2xCQlVsT1lheENOU2VsNUtKOFNQZS1uV1l5dmRWREJ6RUJaRkRsU016SV9VTU5iWGhzZjJtTEd1TTA5TVZvaVpUUGNpMTcxTmpiWUdhejZHUXUyRkNybzQxejRlem9yTmVfRGEzTmE2TlFXQW5HUVZHUzZYb1JVa28xNThvLTJBamlCYnJwNlQtZ0NMRllDZUNiLVlicV8tV241Y0ZuaUxQRUtPc0thQnpqUUwwb3U2WmRqVlliR1RfX1R2Y3dCYVNxdHhFR3Q1R2tpZGtvbVFXaGVveVhuekVYSk9SVU03VDVnRHhrRV80a1R4d0hiOVZ2LWpnalJMNVFVR1luZlEwanlwYW4tRmdzdktseXBvVEZhd1V5MGhDS1lCRVpGRVBQSE1LalpnczFBWnI5eTZiZVdIYV9Yck0yWUhMZyIsInNvdXJjZSI6ImJyb3dzZXIiLCJpc3MiOiJJbnRlbCBHZXRpIiwic3ViIjoiNTFlNjNiYjktNDMyNC00ODdhLWE2ODAtZTQzOTU0MGFjODJlIiwiYXVkIjpbIndlYl91aSJdLCJleHAiOjE3MDcyOTQzMjksIm5iZiI6MTcwNzI5NDI2OSwiaWF0IjoxNzA3Mjk0MjY5fQ.hYCuEYbiTu-zajj62jwblj-XK3D4l054-SV1JG0iP8dTZKuIgJ7S1BSFgcpEpONmG_YrXlFK9yhUkYNyQMxctoDKA-XcRIQyi58Lfj87jWElEjI7mOp4l3fEuisopcKA1gdqd4jjytDqU_mi_JcBFvn_Av9xa5QSTHZ_bbUAkjv5lX0zuJS-O-c7Q43XzPeEI6MfP1tFfO6rDp-o_p_smRD647_1n_LgyNxnoL9OTO-LBZ7QZcCMh5B5PCfTJNXxlgcQL2Cep5fI-hYrA5zQO_-f7gCV5zUCKTb1KXkAHp1EAjipEm_wDK2p0Sa2tmynoOXwOu6DVHW1S7ttct-jo_v-jodwwDFmlzUcLIQ540OMtPZX2HxL-Ou0mG82b76jMwaUhwxKo9KAdBqXO_5nubQarnJLZp0fgkE7F95IqIl49GxgMyrvJh0q_ucrlJyH7x8FbxksOiwj5-rZSNE2Cd6EnZL1-MS3G_uQJc6inn7pDlxLdEvc87dJQnL3s9oarm7wI55EYvlEpexzjchLbS6YWLxYa_xVv2WVL21irPVHYeoDGdk42TFwOr4j5Hu9Kl4d-Q0sJ-1N_Gs43qsB9jAQM3FXUWix3oqyqLYtSWzZxjSyz-Hz44C1rNCkPn5VqcQEA7KgPA8aYfkpWSO0DesrL1ZOmJP7KdJm8Ttbbug"},
            "method": "POST",
        }}},
        "parsed_path": ["onboarding", "user"]
    }
}

test_onboarding_token_generation_for_SaaS_admin_allowed {
    allow with input as {
        "attributes": {"request": {"http": {
            "headers": {"x-auth-request-access-token": "eyJhbGciOiJub25lIn0.eyJpc3MiOiJodHRwczovLzEwLjU1LjI1Mi4xMDEvZGV4Iiwic3ViIjoiQ2lSamJqMTFhV1JBWlhoaGJYQnNaUzV2Y21jc1pHTTlaWGhoYlhCc1pTeGtZejF2Y21jU0RYSmxaM1ZzWVhKZmRYTmxjbk0iLCJhdWQiOiJmd0NEWEs1dXNWT2hKaHlJWWpnaCIsImV4cCI6MTY4NTUzODg3OCwiaWF0IjoxNjg1NTM4ODc4LCJhdF9oYXNoIjoibUtxbWN2NzF3ZDl2Q0FSRWZURUR1dyIsImVtYWlsIjoibWFpbEBleGFtcGxlLm9yZyIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJuYW1lIjoidWlkQGV4YW1wbGUub3JnIiwicHJlZmVycmVkX3VzZXJuYW1lIjoiIn0."},
            "method": "POST",
        }}},
        "parsed_path": ["admin", "onboarding", "tokens"]
    }
}

test_onboarding_token_generation_for_user_not_allowed {
    not allow with input as {
        "attributes": {"request": {"http": {
            "headers": {"x-auth-request-access-token": "eyJhbGciOiJSUzUxMiIsImtpZCI6IjYxOWI0OTg2MzM5ZTgyMmFlOTM3YjNkNWFlZTJjZWY2MmE1MDA5YjM2MzQzYmE5MzY0MTVhM2MyMTNhY2FiOTRlZmExNmFhZDdhNzI0ZjNkNTk1ZmRiNjlkNDY5MTU1MDcxNWVhYWM4ZmUzMWQ3Yjg5NDJjMGE0YjY3YTZkODBlIiwidHlwIjoiSldUIn0.eyJyb2xlcyI6bnVsbCwidGlkIjoiIiwicHJlZmVycmVkX3VzZXJuYW1lIjoiNTFlNjNiYjktNDMyNC00ODdhLWE2ODAtZTQzOTU0MGFjODJlIiwib3JnYW5pemF0aW9uX2lkIjoiYTM1MGI0NTQtY2M4MC00ZDQxLWI3MmQtMzA2MzNkNjNmMjRkIiwiZXh0ZXJuYWxfdG9rZW4iOiJleUpoYkdjaU9pSlNVekkxTmlJc0ltdHBaQ0k2SW1OaU1XVmlNakJrTWpreU9URmhPVGd6WXpabFkyRTRaak14WXpRNVlUZGxZelF6TmpFME16VWlmUS5leUpwYzNNaU9pSm9kSFJ3Y3pvdkx6RXdMalUxTGpJMU1pNHhOVEF2WkdWNElpd2ljM1ZpSWpvaVEycHNhbUpxTURGTlYxVXlUVEpLYVU5VE1EQk5la2t3VEZSUk5FNHlSWFJaVkZrMFRVTXhiRTVFVFRWT1ZGRjNXVmROTkUxdFZYTmFSMDA1V2xob2FHSllRbk5hVTNocldYb3hkbU50WTFORVdFcHNXak5XYzFsWVNtWmtXRTVzWTI1Tklpd2lZWFZrSWpvaWQyVmlYM1ZwSWl3aVpYaHdJam94TnpBM01qazRORFE1TENKcFlYUWlPakUzTURjeU9UUXlORGtzSW1GMFgyaGhjMmdpT2lKclpWTmZUM3B6Tms0eGNpMXNhbko2V2s5WWFHVkJJaXdpWTE5b1lYTm9Jam9pU1haVVl6SjVVREF5WlUxdlRIWmxOWFpqUTNwamR5SXNJbVZ0WVdsc0lqb2lZV1J0YVc1QWMyTXRjSEp2YW1WamRDNXBiblJsYkM1amIyMGlMQ0psYldGcGJGOTJaWEpwWm1sbFpDSTZkSEoxWlN3aWJtRnRaU0k2SWpVeFpUWXpZbUk1TFRRek1qUXRORGczWVMxaE5qZ3dMV1UwTXprMU5EQmhZemd5WlNJc0luQnlaV1psY25KbFpGOTFjMlZ5Ym1GdFpTSTZJalV4WlRZelltSTVMVFF6TWpRdE5EZzNZUzFoTmpnd0xXVTBNemsxTkRCaFl6Z3laU0o5Lm5ydkF1THRmZ19hVzdtcWZFeW5Zb2FMc2xCQlVsT1lheENOU2VsNUtKOFNQZS1uV1l5dmRWREJ6RUJaRkRsU016SV9VTU5iWGhzZjJtTEd1TTA5TVZvaVpUUGNpMTcxTmpiWUdhejZHUXUyRkNybzQxejRlem9yTmVfRGEzTmE2TlFXQW5HUVZHUzZYb1JVa28xNThvLTJBamlCYnJwNlQtZ0NMRllDZUNiLVlicV8tV241Y0ZuaUxQRUtPc0thQnpqUUwwb3U2WmRqVlliR1RfX1R2Y3dCYVNxdHhFR3Q1R2tpZGtvbVFXaGVveVhuekVYSk9SVU03VDVnRHhrRV80a1R4d0hiOVZ2LWpnalJMNVFVR1luZlEwanlwYW4tRmdzdktseXBvVEZhd1V5MGhDS1lCRVpGRVBQSE1LalpnczFBWnI5eTZiZVdIYV9Yck0yWUhMZyIsInNvdXJjZSI6ImJyb3dzZXIiLCJpc3MiOiJJbnRlbCBHZXRpIiwic3ViIjoiNTFlNjNiYjktNDMyNC00ODdhLWE2ODAtZTQzOTU0MGFjODJlIiwiYXVkIjpbIndlYl91aSJdLCJleHAiOjE3MDcyOTQzMjksIm5iZiI6MTcwNzI5NDI2OSwiaWF0IjoxNzA3Mjk0MjY5fQ.hYCuEYbiTu-zajj62jwblj-XK3D4l054-SV1JG0iP8dTZKuIgJ7S1BSFgcpEpONmG_YrXlFK9yhUkYNyQMxctoDKA-XcRIQyi58Lfj87jWElEjI7mOp4l3fEuisopcKA1gdqd4jjytDqU_mi_JcBFvn_Av9xa5QSTHZ_bbUAkjv5lX0zuJS-O-c7Q43XzPeEI6MfP1tFfO6rDp-o_p_smRD647_1n_LgyNxnoL9OTO-LBZ7QZcCMh5B5PCfTJNXxlgcQL2Cep5fI-hYrA5zQO_-f7gCV5zUCKTb1KXkAHp1EAjipEm_wDK2p0Sa2tmynoOXwOu6DVHW1S7ttct-jo_v-jodwwDFmlzUcLIQ540OMtPZX2HxL-Ou0mG82b76jMwaUhwxKo9KAdBqXO_5nubQarnJLZp0fgkE7F95IqIl49GxgMyrvJh0q_ucrlJyH7x8FbxksOiwj5-rZSNE2Cd6EnZL1-MS3G_uQJc6inn7pDlxLdEvc87dJQnL3s9oarm7wI55EYvlEpexzjchLbS6YWLxYa_xVv2WVL21irPVHYeoDGdk42TFwOr4j5Hu9Kl4d-Q0sJ-1N_Gs43qsB9jAQM3FXUWix3oqyqLYtSWzZxjSyz-Hz44C1rNCkPn5VqcQEA7KgPA8aYfkpWSO0DesrL1ZOmJP7KdJm8Ttbbug"},
            "method": "POST",
        }}},
        "parsed_path": ["admin", "onboarding", "tokens"]
    }
}
